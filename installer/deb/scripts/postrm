#!/bin/bash

# This script is used to uninstall MassaStation from a Debian-based system.
# It will remove the following files:
# - MassaStation App.
# - DNSMasq configuration files.
# - Certificates generated for MassaStation.
# - MassaStation configuration directory.
# - MassaStation plugins.

set -e

# Set MassaStation configuration directory.
export MASSASTATION_CONFIG_DIR=/usr/local/share/massastation
export MASSASTATION_CERT_DIR=/etc/massastation/certs

# Print error message to stderr and exit with code 1.
fatal() {
    echo "FATAL: $1" >&2
    exit 1
}

# Warn prints a given message in yellow.
warn() {
    echo -e "\033[1;33m$1\033[0m"
}

wait_for_network() {
    counter=0
    timeout=30 # Timeout in seconds

    while [[ $(nmcli networking connectivity check) == "none" ]] && ((counter < timeout)); do
        echo "Waiting for network manager to be up and running"
        sleep 1
        ((counter+=1))
    done

    if ((counter >= timeout)); then
        fatal "Network manager is not available: Timeout reached. "
    fi
}

# Remove DNSMasq configuration files.
remove_dnsmasq_configuration() {
    sudo rm -f /etc/NetworkManager/dnsmasq.d/massa.conf || fatal "failed to remove DNSMasq configuration files."
    sudo rm -f /etc/resolver/massa || fatal "failed to remove resolver configuration file."

    systemctl restart NetworkManager || fatal "dnsmasq service failed to restart"
    wait_for_network
}

remove_massastation() {
    echo "Removing DNSMasq configuration files..."
    remove_dnsmasq_configuration

    echo "Removing MassaStation configuration directory..."
    sudo rm -rf $MASSASTATION_CONFIG_DIR || fatal "failed to remove MassaStation configuration directory."

    echo "Removing MassaStation certificates..."
    sudo rm -rf $MASSASTATION_CERT_DIR || fatal "failed to remove MassaStation certificates."

    echo "MassaStation was successfully uninstalled. We're sorry to see you go."
}

main() {
    warn "This script will remove anything related to MassaStation from your system."
    warn "This includes the MassaStation App, configuration files, plugins, and every other files generated by MassaStation or it's plugins."
    remove_massastation
    exit 0
}

case "$1" in
remove | purge)
    main
    ;;
*)
    echo "POSTRM script: not a remove or purge operation, skipping uninstallation."
    exit 0
    ;;
esac
