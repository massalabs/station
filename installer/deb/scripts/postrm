#!/bin/bash

# This script is used to uninstall MassaStation from a Debian-based system.
# It will remove the following files:
# - MassaStation App.
# - entry in /etc/hosts.
# - Certificates generated for MassaStation.
# - MassaStation configuration directory.
# - MassaStation plugins.

set -e

# Set MassaStation configuration directory.
export MASSASTATION_CONFIG_DIR=/usr/local/share/massastation
export MASSASTATION_CERT_DIR=/etc/massastation/certs

# Print error message to stderr and exit with code 1.
fatal() {
    echo "FATAL: $1" >&2
    exit 1
}

# Warn prints a given message in yellow.
warn() {
    echo -e "\033[1;33m$1\033[0m"
}

remove_station_redirection() {
    echo "Removing station.massa redirection from /etc/hosts..."
    sudo sed -i '/station.massa/d' /etc/hosts || fatal "failed to remove station.massa redirection from /etc/hosts."
}

remove_massastation() {
    echo "Removing MassaStation configuration directory..."
    sudo rm -rf $MASSASTATION_CONFIG_DIR || fatal "failed to remove MassaStation configuration directory."

    echo "Removing MassaStation certificates..."
    sudo rm -rf $MASSASTATION_CERT_DIR || fatal "failed to remove MassaStation certificates."

    remove_station_redirection

    echo "MassaStation was successfully uninstalled. We're sorry to see you go."
}

main() {
    warn "This script will remove anything related to MassaStation from your system."
    warn "This includes the MassaStation App, configuration files, plugins, and every other files generated by MassaStation or it's plugins."
    remove_massastation
    exit 0
}

case "$1" in
remove | purge)
    main
    ;;
*)
    echo "POSTRM script: not a remove or purge operation, skipping uninstallation."
    exit 0
    ;;
esac
