name: API

on:
  push:

env:
  NODE_SERVER: BUILDNET

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project directory
        uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/install
        with:
          os: ubuntu-latest
      - name: fetch tags
        run: git fetch --tags
      - name: Update version
        run: git describe --tags --abbrev=0 --always > cmd/thyra-server/version.txt
      - name: Build thyra binary
        run: GOOS=linux GOARCH=amd64 CGO_ENABLED=1 CC=gcc CXX=g++ go build cmd/thyra-server/main.go
      - name: Prepare thyra to be runned
        run: |
          sudo mkdir -p /usr/local/share/massastation/
          sudo chmod 777 /usr/local/share/massastation/
          mkdir -p /usr/local/share/massastation/plugins/wallet-plugin
          sudo mkdir -p /etc/massastation/certs
          sudo chmod 777 /etc/massastation/
          sudo setcap CAP_NET_BIND_SERVICE=+eip ./main
          sudo apt install xvfb
      - name: Running thyra
        run: xvfb-run ./main --node-server $NODE_SERVER &
      - name: Define my.massa
        run: sudo echo "127.0.0.1 my.massa" | sudo tee -a /etc/hosts
      - name: Wait for server to be up
        uses: juliangruber/sleep-action@v1
        with:
          time: 5s
      - name: Test plugin manager API
        uses: matt-ball/newman-action@master
        with:
          collection: api/test/plugin_manager.postman_collection.json
          environment: api/test/plugin_manager.postman_environment.json
      - name: Test massa API
        uses: matt-ball/newman-action@master
        with:
          collection: api/test/massa_endpoints.postman_collection.json

  test-api-robot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project directory
        uses: actions/checkout@v3
      - name: Install RobotFramework tests dependencies
        working-directory: api/test
        run: |
          pip install -r requirements.txt
          sudo apt install xvfb
      - name: Install dependencies
        uses: ./.github/actions/install
      - name: Build thyra binary
        run: go build cmd/thyra-server/main.go
      - name: Create wallet from secret
        run: |
          sudo mkdir -p /usr/local/share/massastation/
          sudo chmod 777 /usr/local/share/massastation/
          mkdir -p /usr/local/share/massastation/plugins/wallet-plugin
          sudo mkdir -p /etc/massastation/certs
          sudo chmod 777 /etc/massastation/
          echo "$WALLET_TEST_WALLET" > /usr/local/share/massastation/plugins/wallet-plugin/wallet_rftest.yml
        env:
          WALLET_TEST_WALLET: ${{ secrets.WALLET_TEST_WALLET }}
      - name: Prepare thyra to be runned
        run: sudo setcap CAP_NET_BIND_SERVICE=+eip ./main
      - name: Running thyra
        run: xvfb-run ./main --node-server $NODE_SERVER &
        env:
          WALLET_TEST_MODE: 1
          WALLET_rftest_PASSWORD: ${{ secrets.WALLET_TEST_PASSWORD }}
      - name: Define my.massa
        run: sudo echo "127.0.0.1 my.massa" | sudo tee -a /etc/hosts
      - name: Wait for server to be up
        uses: juliangruber/sleep-action@v1
        with:
          time: 5s
      - name: Run RobotFramework tests
        working-directory: api/test
        run: |
          mkdir results
          robot --outputdir results robot_tests
