name: API

on:
  push:
    paths:
      - 'api/swagger/server/restapi/resource/swagger.yml'
      - 'api/test/*'

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: installing dependencies
        uses: ./.github/actions/install
        with:
          os: ubuntu-latest
      - name: Update version
        run: echo -e "${GITHUB_REF_NAME}" > cmd/thyra-server/version.txt
      - name: Build binary for ${{ matrix.target }} on ${{ matrix.arch}}
        run: GOOS=linux GOARCH=amd64 CGO_ENABLED=1 CC=gcc CXX=g++ go build
      - name: Run thyra
        run: ./main &
      - name: Define my.massa
        run: echo "127.0.0.1    my.massa" > /etc/hosts
      - uses: matt-ball/newman-action@master
        with:
          collection: api/test/plugin_manager.postman_collection.json
          environment: api/test/plugin_manager.postman_environment.json